"use strict";const G_L=new LangData("backup-lang");function backup_getFirstSelectedId(e){let t={id:"",dataId:""};const a=document.querySelectorAll("table#"+e+" tbody tr");for(let e=0;e<a.length;e+=1)if(a[e].querySelector(".checkbox-simple-cntr input[type=checkbox]").checked){t.id=a[e].id,t.dataId=a[e].dataset.id;break}return t}function backup_typeSelector(e,t){const a=document.getElementById("backup-setting-host"),l=document.getElementById("backup-setting-port"),c=document.getElementById("backup-setting-user"),s=document.getElementById("backup-setting-pass-cntr"),n=document.getElementById("backup-setting-remote-dir");if(!(a&&l&&c&&s&&n))return;const o=document.querySelector("label[for=backup-setting-host]"),i=document.querySelector("label[for=backup-setting-port]"),u=document.querySelector("label[for=backup-setting-user]"),r=document.querySelector("label[for=backup-setting-remote-dir]");if(o&&i&&u&&r)switch(e.target.value){case"local":enableClass_DBlock(a,!1),enableClass_DBlock(l,!1),enableClass_DBlock(c,!1),enableClass_DBlock(s,!1),enableClass_DBlock(n,!1),enableClass_DBlock(o,!1),enableClass_DBlock(i,!1),enableClass_DBlock(u,!1),enableClass_DBlock(r,!1);break;default:enableClass_DBlock(a,!0),enableClass_DBlock(l,!0),enableClass_DBlock(c,!0),enableClass_DBlock(s,!0),enableClass_DBlock(n,!0),enableClass_DBlock(o,!0),enableClass_DBlock(i,!0),enableClass_DBlock(u,!0),enableClass_DBlock(r,!0);break}}async function backup_Add_Confirm(e,t){if("backup-add-confirm"!==e.target.id)return;const a=new ButtonState("backup-add-confirm"),l=await fetchText_Post("/backup/?a=backup-add-confirm&t="+csrf_getPageToken(),"");a.restore(),isFetchedDataValid(l)&&"OK"===l&&notificationNew_add(G_L.raw("backup creation scheduled, status can be seen in background tasks"),!1)}async function backup_Post_runActionByIds(e,t){if(!params_Validate(t,"ge",2))return;if("modal-submit"!==e.target.id)return;const a=document.getElementById("modal-backup-file"),l=document.getElementById("modal-backup-site"),c=document.getElementById("modal-backup-db"),s=document.getElementById("modal-backup-mail"),n=document.getElementById("modal-backup-cron");if(!(a&&l&&c&&s&&n))return;let o=[];a.checked&&o.push(a.value),l.checked&&o.push(l.value),c.checked&&o.push(c.value),s.checked&&o.push(s.value),n.checked&&o.push(n.value);const i=new PrepData(2);let u=!1;if(i.prepareString(0,t[1])||(u=!0),i.prepareString(1,o.join(","))||(u=!0),u)return;const r=new ButtonState("modal-submit"),d=await fetchText_Post(t[0]+"&t="+csrf_getPageToken(),i.arr.join(" "));r.restore(),isFetchedDataValid(d)&&("OK"===d&&t[2]&&"string"==typeof t[2]&&notificationNew_add(t[2],!1),modal_Close(e,null))}async function backup_openRestoreWnd(e,t){if(!params_Validate(t,"e",3))return;const a=t[0],l=t[1],c=['<div class="row jc-between h-2"><p class="modal-title">'+G_L.esc("Restore backup")+'</p><span id="modal-close" class="modal-close">&times;</span></div><hr>\n'],s=backup_getFirstSelectedId(a);if(!s||!s.id||"string"!=typeof s.id)return void notificationNew_addError("no row selected");c.push('<label class="checkbox-simple-cntr m-b1 m-t1"><input id="modal-backup-file" type="checkbox" class="input-checkbox" value="file" checked>'+G_L.esc("User files and directories in home directory")+"</label>"),c.push('<label class="checkbox-simple-cntr m-b1 m-t1"><input id="modal-backup-site" type="checkbox" class="input-checkbox" value="site" checked>'+G_L.esc("Web directory with sites")+"</label>"),c.push('<label class="checkbox-simple-cntr m-b1 m-t1"><input id="modal-backup-db" type="checkbox" class="input-checkbox" value="db" checked>'+G_L.esc("Databases")+"</label>"),c.push('<label class="checkbox-simple-cntr m-b1 m-t1"><input id="modal-backup-mail" type="checkbox" class="input-checkbox" value="mail" checked>'+G_L.esc("Mail")+"</label>"),c.push('<label class="checkbox-simple-cntr m-b1 m-t1"><input id="modal-backup-cron" type="checkbox" class="input-checkbox" value="cron" checked>'+G_L.esc("Cron jobs")+"</label>"),c.push('<p class="d-block m-t1 m-b1 c-redlight f-1">'+G_L.esc("backup will be restored, current data will be deleted or replaced!")+"</p>\n"),c.push('<p class="d-block m-t1 m-b1">'+G_L.esc("Backup to restore")+":</p>\n"),c.push('<textarea class="w-100p h-5" readonly>'+Html.escape(s.dataId)+"</textarea>"),c.push('<a id="modal-submit" class="btn">'+G_L.esc("Confirm")+"</a>");const n=document.getElementById("modal-content");n&&(n.innerHTML=c.join("\n"));const o=document.getElementById("modal-popup");o&&(o.style.display="block"),modal_Open(null,null),listener_AddSingleById("modal-close","mouseup",null,null,modal_Close),listener_AddSingleById("modal-popup","mouseup",null,null,modal_Close);let i=s.id;listener_AddSingleById("modal-submit","mouseup","keyup","Enter",backup_Post_runActionByIds,l,i,G_L.esc("backup restoration started, check status in background tasks"))}async function backup_Setting_Confirm(e,t){const a=new PrepData(7);let l=!1;if(a.prepareRadio(0,["#backup-setting-type-local","#backup-setting-type-ftp","#backup-setting-type-sftp"])||(l=!0),l)return;if(("ftp"===a.arr[0]||"sftp"===a.arr[0])&&(a.prepareValue(1,"#backup-setting-host",!0,G_L.raw("host")+G_L.raw("is required"))||(l=!0),a.prepareValue(2,"#backup-setting-port",!0,G_L.raw("port")+G_L.raw("is required"))||(l=!0),a.prepareValue(3,"#backup-setting-user",!0,G_L.raw("user")+G_L.raw("is required"))||(l=!0),a.prepareValue(4,"#backup-setting-pass",!0,G_L.raw("password")+G_L.raw("is required"))||(l=!0),a.prepareValue(6,"#backup-setting-remote-dir",!0,G_L.raw("remote directory")+G_L.raw("is required"))||(l=!0),l))return;a.prepareValue(5,"#backup-setting-quota",!1,"");const c="backup-setting-confirm",s=new ButtonState(c),n=await fetchText_Post("/backup/?a="+c,a.arr.join(" "));s.restore(),isFetchedOk(n,"/backup/")}common_listeners(),listener_AddSingleById("backup-setting-type-local","change",null,null,backup_typeSelector),listener_AddSingleById("backup-setting-type-ftp","change",null,null,backup_typeSelector),listener_AddSingleById("backup-setting-type-sftp","change",null,null,backup_typeSelector),listener_AddSingleById("backup-setting-pass-gen","click",null,null,button_passwordGen,"backup-setting-pass"),listener_AddSingleById("backup-setting-pass-vis","click",null,null,button_togglePasswordVisible,"backup-setting-pass"),listener_AddSingleById("backup-add-confirm","click","keyup","Enter",backup_Add_Confirm),listener_AddSingleById("backup-restore-wnd","click","keyup","Enter",backup_openRestoreWnd,"tbl-backup","/backup/?a=backup-restore-confirm"),listener_AddSingleById("backup-delete-wnd","click","keyup","Enter",table_openDeleteWnd,"tbl-backup","/backup/?a=backup-delete","/backup/",G_L.esc("Delete")+" "+G_L.esc("backups"),G_L.esc("Next items will be deleted"),G_L.esc("Confirm"),null),listener_AddSingleById("backup-setting-confirm","click","keyup","Enter",backup_Setting_Confirm),listeners_Add("table.tbl-fixed tbody","tr","mouseup",null,null,table_OnClickRouter,""),listener_AddSingleById("backup-date-sort","click",null,null,table_Sort,"/backup/","backup-table-sort","sort-no,sort-date-az,sort-date-za"),listener_AddSingleById("backups-checkbox-header","mouseup",null,null,table_SetAllCheckboxes,"table#tbl-backup tbody tr td .checkbox-simple-cntr input[type=checkbox]"),listeners_Add(null,".pageidx","click",null,null,table_SelectPage,"backup-table-page","/backup/"),listener_AddSingleById("backup-table-setting","click","keyup","Enter",tableSetting_Modal_OpenWnd,JSON.stringify({id:"backup-table-setting",cookie:"backup-table-setting",path:"/backup/",titles:[G_L.esc("Settings"),G_L.esc("Number of rows"),G_L.esc("custom"),G_L.esc("Confirm")],values:[1,2,4,8,16],names:["filename","datetime","size","runtime","type"],labels:[G_L.esc("filename"),G_L.esc("date"),G_L.esc("size"),G_L.esc("time took"),G_L.esc("location")]}));
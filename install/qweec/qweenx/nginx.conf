user             qweenx;
worker_processes auto;

events {
    worker_connections  256;
    use                 epoll;
    multi_accept        off;
}

http {
    include       mime.types;
    default_type  application/octet-stream;

    log_format  main    '$remote_addr - $remote_user [$time_local] $request ' '"$status" $body_bytes_sent "$http_referer" ' '"$http_user_agent" "$http_x_forwarded_for"';

    sendfile                       on;
    tcp_nopush                     on;
    tcp_nodelay                    on;
    keepalive_timeout              60 60;

    large_client_header_buffers    4 8k;
    client_header_buffer_size      2k;
    client_body_buffer_size        256k;
    client_max_body_size           16m;
    client_header_timeout          60s;
    client_body_timeout            180s;
    send_timeout                   30s;
    reset_timedout_connection      on;
    server_tokens                  off;
    server_name_in_redirect        off;
    server_names_hash_max_size     512;
    server_names_hash_bucket_size  512;

    ssl_protocols              TLSv1.2 TLSv1.3;
    ssl_session_cache          shared:SSL:5m;
    ssl_early_data             on;
    ssl_ecdh_curve             auto;
    ssl_prefer_server_ciphers  on;
    ssl_ciphers                TLS_AES_256_GCM_SHA384:TLS_CHACHA20_POLY1305_SHA256:TLS_AES_128_GCM_SHA256:ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-SHA256:ECDHE-ECDSA-AES128-SHA256:ECDHE-RSA-AES256-SHA384:ECDHE-ECDSA-AES256-SHA384:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:DHE-RSA-AES128-GCM-SHA256:DHE-RSA-AES256-SHA256:DHE-RSA-AES128-SHA256:DHE-RSA-AES256-GCM-SHA384:AES256-GCM-SHA384:AES256-SHA256:!RC4-MD5:!RC4-SHA:!NULL-SHA:!NULL-MD5:!MD5;

    # proxy
    proxy_redirect             off;
    proxy_set_header           Host $host;
    proxy_set_header           Early-Data $rfc_early_data;
    proxy_set_header           X-Real-IP $remote_addr;
    proxy_set_header           X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_pass_header          Set-Cookie;
    proxy_buffers              256 4k;
    proxy_buffer_size          32k;
    proxy_busy_buffers_size    32k;
    proxy_temp_file_write_size 256k;
    proxy_connect_timeout      30s;
    proxy_read_timeout         300s;
    proxy_send_timeout         300s;

    # security headers
    add_header X-XSS-Protection "1; mode=block";
    add_header X-Frame-Options "SAMEORIGIN";
    add_header X-Content-Type-Options nosniff;
    add_header Referrer-Policy "strict-origin";
    add_header Permissions-Policy "geolocation=(), microphone=(), camera=()";
    # add_header Content-Security-Policy "default-src 'self'; img-src *; script-src 'self'; style-src 'self'";
    add_header Content-Security-Policy 'upgrade-insecure-requests';
    # add_header Strict-Transport-Security 'max-age=31536000; includeSubDomains; preload';

    # tls1.3 security (0-RTT anti-replay)
    map "$request_method:$is_args" $ar_idempotent {
        default 0;
        "~^GET:$|^(HEAD|OPTIONS|TRACE):\?*$" 1;
    }
    map $http_user_agent $ar_support_425 {
        default 0;
        "~Firefox/((58|59)|([6-9]\d)|([1-9]\d{2,}))\.\d+" 1;
    }
    map "$ssl_early_data:$ar_idempotent:$ar_support_425" $anti_replay {
        1:0:0 307;
        1:0:1 425;
    }
    map "$ssl_early_data:$ar_support_425" $rfc_early_data {
        1:1 1;
    }

    # gzip
    gzip               on;
    gzip_vary          on;
    gzip_proxied       any;
    gzip_comp_level    5;
    gzip_min_length    1024;
    gzip_buffers       128 4k;
    gzip_http_version  1.1;
    gzip_types         text/css text/javascript text/js text/plain text/x-component text/x-markdown text/x-script text/xml image/bmp image/svg+xml image/x-icon font/otf font/ttf font/x-woff multipart/bag multipart/mixed application/eot application/font application/font-sfnt application/font-woff application/javascript application/javascript-binast application/json application/ld+json application/manifest+json application/opentype application/otf application/rss+xml application/ttf application/truetype application/wasm application/xhtml+xml application/xml application/xml+rss application/x-httpd-cgi application/x-javascript application/x-opentype application/x-otf application/x-perl application/x-protobuf application/x-ttf;

    # server virtual host
	server {
        listen 1505 ssl;
        http2 on;

        # listen 1505 quic reuseport;
        # http3 on;
        # quic_retry on;
        # quic_gso on;
        # ssl_early_data on;

		server_name _;
		root /usr/local/qweec/web/public;
        index index.html;
		# fix error "The plain HTTP request was sent to HTTPS port"
		error_page          497 https://$host:$server_port$request_uri;
		error_page          403 /errorpage/404.html;
		error_page          404 /errorpage/404.html;
		error_page          410 /errorpage/410.html;
		error_page          500 501 502 503 504 505 /errorpage/50x.html;

		ssl_certificate_key /usr/local/qweec/cert/qweenx.key;
		ssl_certificate     /usr/local/qweec/cert/qweenx.pem;

		# tls1.3 0-RTT anti-replay
		if ($anti_replay = 307) { return 307 https://$host:$server_port$request_uri; }
		if ($anti_replay = 425) { return 425; }

        
        # todo: maybe no need to add it, as i will be making explicit requests with trailing slash
        # add slash to all requests, except those that contains .
        location ~ ^([^.\?]*[^/])$ {
            rewrite ^([^.]*[^/])$ $1/ permanent;
        }

        # disallow requests with 2 or more consequential slashes
        # location block does not work here, to short request and it is regex, so not executed, use if instead, but be careful with its block inheritance
        # location  ~ ^.*\/\/+.*$ { return 403; }
        if ($request_uri ~ "^.*//+.*$") { return 403; }
        
        # noneed 
        # do not allow getting hidden files, except .well-known/
		# location ~ /\.(?!well-known\/) {
		#     deny all;
		#     return 404;
		# }

		# noneed, cache will not be used
        # no cache for accesstoken cookies
		# proxy_no_cache $no_cache;
		# set $no_cache 0;
		# if ($http_cookie ~ accesstoken) {
		# set $no_cache 1;
		# }

		location / {

            # # add_header Strict-Transport-Security "max-age=31536000; includeSubDomains; preload";
            # add_header X-Quic "status=$http3" always;
            # add_header Alt-Svc 'h3=":$server_port"; ma=86400';
            # add_header Alt-Svc 'h3-23=":$server_port"';
            # add_header Alt-Svc 'h3-27=":$server_port"';
            # add_header Alt-Svc 'h3-29=":$server_port"; ma=86400';

			# try_files $uri $uri/ /index.html?$args;
            try_files $uri $uri/ /404.html;
            
            limit_except GET { deny all; }

            location = / {
                rewrite ^ /login/ last;
            }

            location ~* ^.+\.(scss)$ {
                deny all;
            }

            location ~* ^.+\.(js|css|html|txt|svg|jpg|png|bmp|webp)$ {
                expires 15d;
                try_files $uri =404;
                add_header Cache-Control "public, max-age=1296000";
            }
		}
        
        location ~ ^/(login|fm|php|software|setting|notification)/$ {
			limit_except GET POST { deny all; }
			try_files /non-existent-file @backend;
		}

        location ~ ^/(user|site|db|dbhost|maildom|mailacc|ftpuser|tpl|ssl|dns|cron|backup|fw|net|monitor|svc)/$ {
			limit_except GET POST DELETE { deny all; }
			try_files /non-existent-file @backend;
		}

		location /task/ {
			limit_except GET DELETE { deny all; }
			try_files /non-existent-file @backend;
		}

		location @backend {
			# add_header Alt-Svc 'h3=":$server_port"; ma=86400';
			proxy_pass http://unix:/run/qweec/web.sock;
			proxy_set_header Host $host;
            proxy_set_header Origin $http_origin;
			proxy_set_header Early-Data $rfc_early_data;
			proxy_set_header X-Real-IP $remote_addr;
			proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
			proxy_set_header X-Forwarded-Proto $scheme;
			proxy_set_header Connection "upgrade";
			proxy_set_header Upgrade $http_upgrade;
			proxy_cache_bypass $http_upgrade;
			proxy_http_version 1.1;
		}

	}


}
